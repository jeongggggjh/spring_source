<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/css/chat.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script type="text/javascript">
	let stompClient = null;

	function connect() {

		let socket = new SockJS('/ws');
		stompClient = Stomp.over(socket);

		stompClient.connect({}, function(frame) {
			console.log('connected : ' + frame);

			// íŠ¹ì • ì£¼ì œ('/topic/public')ë¥¼ êµ¬ë…í•˜ì—¬, ì„œë²„ì—ì„œ ë©”ì„¸ì§€ë¥¼ ìˆ˜ì‹ 
			// ì„œë²„ì™€ ì¼ì¹˜í•˜ëŠ” ì£¼ì œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
			stompClient.subscribe('/topic/public', function(message) {
			    showMessage(message.body);
			});

		})
	}

	function sendMessage() {
	    let nameInput = document.querySelector("#name");
	    let messageInput = document.querySelector("#message");

	    // ìƒˆë¡œìš´ ë³€ìˆ˜ ì„ ì–¸ ë° ì´ˆê¸°í™”
	    let messageContent = messageInput.value;

	    // ì±„íŒ…ëª…(ì´ë¦„) ì…ë ¥ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ê²½ìš°, ì±„íŒ…ëª…ì„ ì…ë ¥ í›„ ì„œë²„ë¡œ ì „ì†¡ ==> ì´ë¦„ ì…ë ¥ë€ì„ ë¹„í™œì„±í™” 
	    if (!nameInput.disabled) {
	        stompClient.send("/app/chat.addUser", {}, JSON.stringify({
	            sender: nameInput.value,
	            type: 'JOIN'
	        }));
	        nameInput.disabled = true;
	    }
	    // ë©”ì„¸ì§€ê°€ ìˆê³ , ì—°ê²°ì´ ëœ ìƒíƒœë¼ë©´ ë©”ì„¸ì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡
	    if (messageContent && stompClient) {
	        let chatMessage = {
	            sender: nameInput.value,
	            content: messageContent,
	            type: 'CHAT'
	        };
	        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
	        document.querySelector("#message").value = '';  // ë©”ì„¸ì§€ ì „ì†¡ í›„ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
	    }
	}


	function showMessage(messageBody) {
	    // JSON ë¬¸ìì—´ì„ ê°ì²´ë¡œ ë³€í™˜
	    let message = JSON.parse(messageBody);
	    let messageElement = document.createElement("li");

	    // ë©”ì„¸ì§€ íƒ€ì…ì— ë”°ë¼ ì¶œë ¥ ë‚´ìš© ë‹¤ë¦„
	    if (message.type === 'JOIN') { // ì±„íŒ… ì…ì¥
	        messageElement.classList.add('event-message');
	        messageElement.textContent = message.sender + " ì…ì¥ ğŸ¥µ";
	    } else if (message.type === 'LEAVE') {
	        messageElement.classList.add('event-message');
	        messageElement.textContent = message.sender + " í‡´ì¥ ğŸ’…ğŸ’„ğŸ‘™ğŸ’•";
	    } else {
	        messageElement.classList.add('chat-message');

	        // ì±„íŒ…ëª… : ë©”ì„¸ì§€ í˜•íƒœë¡œ ì¶œë ¥
	        let userNameElement = document.createElement('strong');
	        userNameElement.classList.add('nickname');
	        let usernameText = document.createTextNode(message.sender + ": ");
	        userNameElement.appendChild(usernameText);
	        messageElement.appendChild(userNameElement);

	        let textElement = document.createElement('span');
	        let messageText = document.createTextNode(message.content);
	        textElement.appendChild(messageText);

	        messageElement.appendChild(textElement);
	    }

	    // ë©”ì„¸ì§€ ìš”ì†Œë¥¼ ë©”ì‹œì§€ ì˜ì—­ì— ì¶”ê°€
	    document.querySelector("#messageArea").appendChild(messageElement);
	}


	function leaveChat() {
	    let nameInput = document.querySelector("#name");
	    if (stompClient) {
	        let chatMessage = {
	            sender: nameInput.value,
	            type: 'LEAVE'
	        };
	        stompClient.send("/app/chat.leaveUser", {}, JSON.stringify(chatMessage));
	        stompClient.disconnect();
	    }

	    document.querySelector("#name").disabled = false;
	    alert("ã…‚ ã…‚ ã…‹ã…‹ã…‹ã…‹ã…‹");
	}


	window.onload = function() {
		connect();
	}

	window.onbeforeunload = function() { // ë¸Œë¼ìš°ì €ê°€ ë‹«íˆê¸° ì „ websocket ì—°ê²° ì¢…ë£Œ
		if (stompClient) {
			stompClient.disconnect();
		}
	}
</script>
</head>
<body>
	<div>
		<input type="text" id="name" placeholder="ì´ë¦„ ì…ë ¥"><br> 
		<input type="text" id="message" size="50" placeholder="ë©”ì„¸ì§€ ì…ë ¥" onkeydown="if (event.keyCode === 13) sendMessage()">
		<button onclick="sendMessage()">ì „ì†¡</button>
		&nbsp;&nbsp;
		<button onclick="leaveChat()">í‡´ì¥</button>
	</div>

	<ul id="messageArea"></ul>
</body>
</html>